<div data-role="page">
  <link rel="stylesheet" href="../css/2d_structure_of_organic_molecules.css">
  <div class="navbar blue">
    <div class="navbar-inner">
      <div class="left">
        <a href="#" class="link" data-rel="back"><i class="material-icons">arrow_back</i></a>
      </div>
      <div class="title">Cấu trúc 2d của phân tử hữu cơ</div>
    </div>
  </div>
  <div class="ui-content">
    <div class="card">
      <label>Nhập công thức cấu tạo</label>
      <input type="text" value="NCC(O)O" data-clear-btn="true" id="input">
    </div>
    <button class="button blue">Hiển thị</button>
    <div class="card">
      <div id="molecularFormula" style="font-size:20px"></div>
      <div id="molecularWeight" style="font-size:20px"></div>
    </div>
    <div class="card">
      <div class="overflow">
        <div id="plot"></div>
      </div>
    </div>
  </div>
  <script>
  $.getScript("../js/2d_structure_of_organic_molecules.js", function() {
    var userExample = 'NCC(O)O';
    $('.button').click(function() {
      parseInput(input.value);
      return !1
    }).rkmd_rippleEffect();

    var parseInput = function(input) {
      if (typeof input !== 'string' || input.length === 0 || input.length > 1000) {
        return null
      }
      var molecule = Molecules.load.smiles(input)
      if (typeof molecule === 'object') {
        update(molecule)
      }
    };

    function convertMolecule(molecule) {
      var atoms = Object.keys(molecule.atoms);
      var bonds = Object.keys(molecule.bonds);
      var nodes = [];
      var links = [];
      for (var i = 0; i < atoms.length; i++) {
        nodes.push({
          id: molecule.atoms[atoms[i]].id,
          name: molecule.atoms[atoms[i]].name,
          protons: molecule.atoms[atoms[i]].protons,
          neutrons: molecule.atoms[atoms[i]].neutrons,
          electrons: molecule.atoms[atoms[i]].electrons,
          bonds: molecule.atoms[atoms[i]].bonds,
          properties: molecule.atoms[atoms[i]].properties
        })
      }
      for (var i = 0; i < bonds.length; i++) {
        links.push({
          id: molecule.bonds[bonds[i]].id,
          name: molecule.bonds[bonds[i]].name,
          value: molecule.bonds[bonds[i]].value,
          source: atoms.indexOf(molecule.bonds[bonds[i]].atoms[0]),
          target: atoms.indexOf(molecule.bonds[bonds[i]].atoms[1]),
          order: molecule.bonds[bonds[i]].order
        })
      }
      return {
        nodes: nodes,
        links: links
      }
    }
    var centerPanel = document.getElementById("plot");
    var mainPanelHeight = 450;
    var mainPanelWidth = 450;
    var mainPanel = d3.select("#plot").append("svg").attr("preserveAspectRatio", "xMinYMin meet").attr("viewBox", "0 0 " + mainPanelWidth + " " + mainPanelHeight + "");
    var forceProperties = {
      size: [mainPanelWidth, mainPanelHeight],
      charge: -1200,
      chargeDistance: 500,
      linkStrength: 1.5,
      linkDistance: -40,
      gravity: 1.3,
      friction: 0.65,
      alpha: 2.0
    }
    var force = d3.layout.force().size(forceProperties.size).charge(forceProperties.charge).chargeDistance(forceProperties.chargeDistance).linkStrength(forceProperties.linkStrength).linkDistance(forceProperties.linkDistance).gravity(forceProperties.gravity).friction(forceProperties.friction).alpha(forceProperties.alpha);

    function update(molecule) {
      var graph = convertMolecule(molecule);
      var nodes = force.nodes(graph.nodes);
      var links = force.links(graph.links);
      d3.selectAll(".node").remove()
      d3.selectAll(".separator").remove()
      var bondMuliplier = 3;
      var piBond = {
        stroke: '#FFFFFF',
        strokeWidth: '2px'
      };
      var aromaticBond = {
        stroke: '#696969',
        strokeWidth: '3px',
        strokeDashArray: ("3,3")
      };
      var bond = mainPanel.selectAll("line.link").data(graph.links, function(d) {
        return d.source + "-" + d.target
      }).enter();
      var singleBond = bond.append("svg:line").filter(function(d) {
        return d.order == 1 | d.order == 2 | d.order == 3
      }).attr("class", "link").style("stroke-width", function(d) {
        return (d.order * bondMuliplier - 1) * (bondMuliplier / 2) + "px"
      })
      var doubleBond = bond.append("svg:line").filter(function(d) {
        return d.order == 2
      }).attr("class", "separator").style("stroke-width", piBond.strokeWidth).style("stroke", piBond.stroke)
      var aromaticBond_1 = bond.append("svg:line").filter(function(d) {
        return d.order == 1.5
      }).attr("class", "separator").style("stroke-width", aromaticBond.strokeWidth).style("stroke", aromaticBond.stroke)
      var aromaticBond_2 = bond.append("svg:line").filter(function(d) {
        return d.order == 1.5
      }).attr("class", "link").style("stroke-width", aromaticBond.strokeWidth).style("stroke", aromaticBond.stroke).style("stroke-dasharray", aromaticBond.strokeDashArray)
      var tripleBond_1 = bond.append("svg:line").filter(function(d) {
        return d.order == 3
      }).attr("class", "separator").style("stroke-width", piBond.strokeWidth).style("stroke", piBond.stroke)
      var tripleBond_2 = bond.append("svg:line").filter(function(d) {
        return d.order == 3
      }).attr("class", "separator").style("stroke-width", piBond.strokeWidth).style("stroke", piBond.stroke)
      mainPanel.selectAll("line.link").data(graph.links, function(d) {
        return d.source + "-" + d.target
      }).exit().remove();
      var maxProtons = 11;
      var maxRadius = 10;
      var minRadius = 2.7;
      var atomMultiplier = 2.8;
      var atom = mainPanel.selectAll("circle").data(graph.nodes, function(d) {
        return Math.random()
      });
      atom.enter().append("circle").attr("class", "node").attr("class", function(d) {
        return 'atom-' + d.name
      }).attr("r", function(d) {
        return (d.protons < maxProtons) ? (Math.sqrt(d.protons + minRadius) * atomMultiplier) : maxRadius
      }).call(force.drag).on("mouseover", function(d) {});
      atom.exit().remove();
      var atomRadius = 9;
      var bondOffset = 2;
      force.start();
      force.on("tick", function() {
        singleBond.attr("x1", function(d) {
          return d.source.x
        }).attr("y1", function(d) {
          return d.source.y
        }).attr("x2", function(d) {
          return d.target.x
        }).attr("y2", function(d) {
          return d.target.y
        });
        doubleBond.attr("x1", function(d) {
          return d.source.x
        }).attr("y1", function(d) {
          return d.source.y
        }).attr("x2", function(d) {
          return d.target.x
        }).attr("y2", function(d) {
          return d.target.y
        });
        aromaticBond_1
          .attr("x1", function(d) {
            return d.source.x - xOffset(bondOffset, d.source, d.target)
          }).attr("y1", function(d) {
            return d.source.y - yOffset(bondOffset, d.source, d.target)
          }).attr("x2", function(d) {
            return d.target.x - xOffset(bondOffset, d.source, d.target)
          }).attr("y2", function(d) {
            return d.target.y - yOffset(bondOffset, d.source, d.target)
          });
        aromaticBond_2
          .attr("x1", function(d) {
            return d.source.x - xOffset(-bondOffset, d.source, d.target)
          }).attr("y1", function(d) {
            return d.source.y - yOffset(-bondOffset, d.source, d.target)
          }).attr("x2", function(d) {
            return d.target.x - xOffset(-bondOffset, d.source, d.target)
          }).attr("y2", function(d) {
            return d.target.y - yOffset(-bondOffset, d.source, d.target)
          });
        tripleBond_1
          .attr("x1", function(d) {
            return d.source.x - xOffset(bondOffset, d.source, d.target)
          }).attr("y1", function(d) {
            return d.source.y - yOffset(bondOffset, d.source, d.target)
          }).attr("x2", function(d) {
            return d.target.x - xOffset(bondOffset, d.source, d.target)
          }).attr("y2", function(d) {
            return d.target.y - yOffset(bondOffset, d.source, d.target)
          });
        tripleBond_2
          .attr("x1", function(d) {
            return d.source.x - xOffset(-bondOffset, d.source, d.target)
          }).attr("y1", function(d) {
            return d.source.y - yOffset(-bondOffset, d.source, d.target)
          }).attr("x2", function(d) {
            return d.target.x - xOffset(-bondOffset, d.source, d.target)
          }).attr("y2", function(d) {
            return d.target.y - yOffset(-bondOffset, d.source, d.target)
          });
        atom.attr("cx", function(d) {
          return d.x = Math.max(atomRadius, Math.min(mainPanelWidth - atomRadius, d.x))
        }).attr("cy", function(d) {
          return d.y = Math.max(atomRadius, Math.min(mainPanelHeight - atomRadius, d.y))
        })
      });
      if (typeof molecule === 'object') {
        updateMolecularWeight(molecule);
        updateMolecularFormula(molecule)
      }
    }

    function xOffset(offset, source, target) {
      var dx = target.x - source.x;
      var dy = target.y - source.y;
      if (dy === 0 || Math.abs(dx / dy) > 1) {
        return offset * (dy / dx)
      } else {
        return offset
      }
    }

    function yOffset(offset, source, target) {
      var dx = target.x - source.x;
      var dy = target.y - source.y;
      if (dy === 0 || Math.abs(dx / dy) > 1) {
        return -offset
      } else {
        return offset * -(dx / dy)
      }
    }

    function getAtomText(atom) {
      var str = atom.name;
      var x = atom.properties.charge;
      var n = '';
      if (x !== 0) {
        if (x === 1) {
          n = '+'
        } else if (x > 1) {
          n = x + '+'
        } else if (x === -1) {
          n = '-'
        } else if (x < -1) {
          n = x + '-'
        }
        str = str.concat('<sup>' + n + '</sup>')
      }
      return str
    }

    function updateMolecularWeight(molecule) {
      var decimalPoints = Math.pow(10, 2);
      var molecularWeight = (Math.round(molecule.properties.mass * decimalPoints) / decimalPoints) + ' g/mol';
      document.getElementById("molecularWeight").innerHTML = molecularWeight
    }

    function updateMolecularFormula(molecule) {
      var molecularFormula = [];
      var atoms = Object.keys(molecule.properties.formula).sort();
      var charge = 0;
      Object.keys(molecule.atoms).forEach(function(key) {
        charge += molecule.atoms[key].properties.charge
      });

      function updateFormula(atomName) {
        var atomCount = molecule.properties.formula[atomName];
        if (atomCount === 1) {
          molecularFormula.push(atomName)
        } else {
          molecularFormula.push(atomName + atomCount)
        }
        atoms.splice(atoms.indexOf(atomName), 1)
      }
      if (atoms.indexOf('Li') !== -1) {
        updateFormula('Li')
      }
      if (atoms.indexOf('Na') !== -1) {
        updateFormula('Na')
      }
      if (atoms.indexOf('Mg') !== -1) {
        updateFormula('Mg')
      }
      if (atoms.indexOf('K') !== -1) {
        updateFormula('K')
      }
      if (atoms.indexOf('Ca') !== -1) {
        updateFormula('Ca')
      }
      if (atoms.indexOf('C') !== -1) {
        updateFormula('C')
      }
      if (atoms.indexOf('H') !== -1) {
        updateFormula('H')
      }
      while (atoms.length > 0) {
        updateFormula(atoms[0])
      }
      molecularFormula = molecularFormula.join('').replace(/(\d+)/g, '<sub>$1</sub>');
      if (charge !== 0) {
        var n = '';
        if (charge === 1) {
          n = '+'
        } else if (charge > 1) {
          n = charge + '+'
        } else if (charge === -1) {
          n = '-'
        } else if (charge < -1) {
          n = charge + '-'
        }
        molecularFormula = molecularFormula.concat('<sup>' + n + '</sup>')
      }
      document.getElementById("molecularFormula").innerHTML = molecularFormula
    }
    parseInput(userExample)
  })
  </script>
</div>